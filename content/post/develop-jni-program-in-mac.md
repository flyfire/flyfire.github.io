+++
title = "Develop Jni Program in Mac"
date = "2017-10-18"
slug = "2017/10/18/develop-jni-program-in-mac"
Categories = ["dev", "java"]
+++

本文主要讲述如何在Mac开发环境下进行JNI开发。

首先编写好Java文件，示例程序主要示范了Java访问C，C访问Java静态与非静态域。

```java
public class HelloJni{
    static{
        System.loadLibrary("HelloJni");
    }
    public native static String getStringFromCStatic();
    public native String getStringFromCNonStatic();
    public String key = "key";
    public static int count = 5;
    public native String accessField();
    public native void accessStaticField();
    public static void main(String[] args){
        System.out.println(getStringFromCStatic());
        HelloJni hello = new HelloJni();
        System.out.println(hello.getStringFromCNonStatic());
        System.out.println("change before key: " + hello.key);
        hello.accessField();
        System.out.println("change after key: " + hello.key);
        System.out.println("change before count: " + count);
        hello.accessStaticField();
        System.out.println("change after count: " + count);
    }
}
```

<!-- more -->

在这个类的static代码块中加载的动态库是``HelloJni``，类库的名字前面需要加``lib``，在linux系统上面类库的扩展名为``so``，在Mac系统上面扩展名为``jnilib``，也就是说我们待会要生成的库的名字是``libHelloJni.jnilib``。

执行``javac HelloJni.java``生成class文件，执行``javah HelloJni``生成``HelloJni.h``头文件。其实生成的头文件都是有套路的，我们其实可以自己手动写。

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class HelloJni */

#ifndef _Included_HelloJni
#define _Included_HelloJni
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     HelloJni
 * Method:    getStringFromCStatic
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_HelloJni_getStringFromCStatic
  (JNIEnv *, jclass);

/*
 * Class:     HelloJni
 * Method:    getStringFromCNonStatic
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_HelloJni_getStringFromCNonStatic
  (JNIEnv *, jobject);

/*
 * Class:     HelloJni
 * Method:    accessField
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_HelloJni_accessField
  (JNIEnv *, jobject);

/*
 * Class:     HelloJni
 * Method:    accessStaticField
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_HelloJni_accessStaticField
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

接下来进行c文件的编写，示例程序演示了C访问java静态与非静态域。

```c
#include "HelloJni.h"
#include <stdio.h>
#include <string.h>

JNIEXPORT jstring JNICALL Java_HelloJni_getStringFromCStatic(JNIEnv * env, jclass clz){
    return (*env)->NewStringUTF(env, "C String static");
}

JNIEXPORT jstring JNICALL Java_HelloJni_getStringFromCNonStatic(JNIEnv * env, jobject obj){
    return (*env)->NewStringUTF(env, "C string non static");
}

JNIEXPORT jstring JNICALL Java_HelloJni_accessField(JNIEnv * env, jobject obj){
    jclass jclz = (*env)->GetObjectClass(env, obj);
    jfieldID fid = (*env)->GetFieldID(env, jclz, "key", "Ljava/lang/String;");
    jstring jstr = (*env)->GetObjectField(env, obj, fid);
    char* c_str = (*env)->GetStringUTFChars(env, jstr, NULL);
    char text[30] = "solarex";
    strcat(text, c_str);
    jstring new_str = (*env)->NewStringUTF(env, text);
    (*env)->SetObjectField(env, obj, fid, new_str);
    (*env)->ReleaseStringChars(env, new_str, c_str);
    return new_str;
}

JNIEXPORT void JNICALL Java_HelloJni_accessStaticField(JNIEnv * env, jobject obj){
    jclass jclz = (*env)->GetObjectClass(env, obj);
    jfieldID fid = (*env)->GetStaticFieldID(env, jclz, "count", "I");
    jint count = (*env)->GetStaticIntField(env, jclz, fid);
    count++;
    (*env)->SetStaticIntField(env, jclz, fid, count);
}
```

接下来就是编译c文件了，在``HelloJni.h``中有``#include <jni.h>``，编译的时候我们需要指出``jni.h``的路径。在Mac系统中``jni.h``在``/System/Library/Frameworks/JavaVM.framework/Headers``目录下。

```
gcc -I/System/Library/Frameworks/JavaVM.framework/Headers -c HelloJni.c //生成.o文件
gcc -dynamiclib -o libHelloJni.jnilib HelloJni.o
```

上面两条命令就生成了动态库。

然后我们再执行``java HelloJni``就可以看到java和c交互的输出了：

```
C String static
C string non static
change before key: key
change after key: solarexkey
change before count: 5
change after count: 6
```

Demo参见[HelloJni](https://github.com/flyfire/HelloJni)。
